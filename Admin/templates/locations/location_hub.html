{% extends 'admin_base.html' %}
{% load static %}

<!-- title for the location page -->
{% block title %}
Admin-Location Hub
{% endblock %}

<!-- css link for location page -->
{% block link %}
<link rel="stylesheet"  href="{% static 'admin/css/locationhub.css' %}">
{% endblock %}


<!-- contents for location page -->
{% block content %}
<div class="container-fluid px-4">
  <!-- breadcrumb section -->
  <ol class="breadcrumb mt-3">
      <li class="breadcrumb-item"><a class="text-decoration-none main-heading" href="{% url 'admin_dashboard' %}">Dashboard</a></li>
      <li class="breadcrumb-item active">Location Hub</li>
  </ol>

  {% if messages %}
  <!-- message section -->
  <div class="row mt-3" >
    <div class="col-lg-7"></div>
    <div class="col-lg-5" id="message-section">
      {% for message in messages %}
      <div class="alert alert-dismissible fade show" role="alert">
        {% if message.tags == 'success' %}
        <strong>Success <i class="fas fa-check-circle icon"></i></strong><span class="ms-2">{{message}}</span>
        {% else %}
        <strong>Sorry <i class="fas fa-warning icon"></i></strong><span class="ms-2">{{message}}</span>
        {% endif %}
        <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="row mt-5">
    <div class="d-grid gap-2 d-md-block">
      <button class="btn1 p-2" data-bs-toggle="modal" data-bs-target="#addlocationmodal"><i class="fas fa-plus"></i> Service Location</button>
      <button class="btn1 p-2" data-bs-toggle="modal" data-bs-target="#addcountrymodal"><i class="fas fa-plus"></i> Country</button>
      <button class="btn1 p-2" data-bs-toggle="modal" data-bs-target="#addstatemodal"><i class="fas fa-plus"></i> State</button>
      <button class="btn1 p-2" data-bs-toggle="modal" data-bs-target="#addcitymodal"><i class="fas fa-plus"></i> City</button>

    </div>

  </div>

  <div class="row mt-3 mb-5">
    <div class="col-lg-12">
      <ul class="nav nav-underline  mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-locations" type="button" role="tab" aria-controls="pills-locations" aria-selected="true">Locations</button>
        </li>
        <!-- <li class="nav-item" role="presentation">
          <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-archive" type="button" role="tab" aria-controls="pills-archive" aria-selected="false">Archive</button>
        </li> -->
          
      </ul>
      <div class="tab-content" id="pills-tabContent">
        <!-- locations add -->
        <div class="tab-pane fade show active" id="pills-locations" role="tabpanel" aria-labelledby="pills-home-tab" tabindex="0">
          <div class="locations mt-5">
              <div class="row">
                <!-- card section -->
                <div class="col-lg-3">

                  <div id="location-card" class="card  mb-3 shadow rounded" style="max-width: 100%">
                    <div class="card-body">
                      <h5 class="card-title text-center mt-2">Locations</h5>
                      <p class="card-text text-center text-white-50">Edit and manage all service available Locations</p>
                    </div>
                  </div>

                  <div id="country-card" class="card  mb-3 shadow rounded" style="max-width: 100%">
                    <div class="card-body">
                      <h5 class="card-title text-center mt-2">Countries</h5>
                      <p class="card-text text-center text-white-50">Edit and manage all service available Countries</p>
                    </div>
                  </div>

                  <div id="state-card" class="card  mb-3 shadow rounded" style="max-width: 100%">
                    <div class="card-body">
                      <h5 class="card-title text-center mt-2">States</h5>
                      <p class="card-text text-center text-white-50">Edit and manage all service available States</p>
                    </div>
                  </div>

                  <div id="city-card" class="card  mb-3 shadow rounded" style="max-width: 100%">
                    <div class="card-body">
                      <h5 class="card-title text-center mt-2">Cities</h5>
                      <p class="card-text text-center text-white-50">Edit and manage all service available Cities</p>
                    </div>
                  </div>

                  

                  

                </div>
                <!-- card related table section -->
                <div class="col-lg-9 mt-lg-0 mt-5">
                  <!-- default lo table -->
                  {% include 'locations/tables.html' %}
                </div>
              </div>
          </div>
        </div>

          
      </div>

    </div>
  </div>

</div>





<!--create Modal -->

<div class="modal fade " id="addcountrymodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog ">
    <div class="modal-content ">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="fas fa-plus"></i> Country</h1>
      </div>
      <div class="modal-body rounded-2 shadow">
        <form action="{% url 'add_country' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="text" name="name" class="form-control mt-2 mb-2" placeholder="Country Name"  required>
          
          <div class="row">
              <div class="col-lg-8"></div>
              <div class="col-lg-4">
                <button type="submit" class="btn1 w-100 mt-2 mb-2">Save <i class="fas fa-save ms-1"></i></button>
              </div>
          </div>
        </form>
          
        
      </div>
      
    </div>
  </div>
</div>


<div class="modal fade " id="addstatemodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog ">
    <div class="modal-content ">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="fas fa-plus"></i> State</h1>
      </div>
      <div class="modal-body rounded-2 shadow">
        <form action="{% url 'add_state' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          
          <input type="text" name="name" class="form-control mt-2 mb-2" placeholder="State Name"  required>
          
          <div class="row">
              <div class="col-lg-8"></div>
              <div class="col-lg-4">
                <button type="submit" class="btn1 w-100 mt-2 mb-2">Save <i class="fas fa-save ms-1"></i></button>
              </div>
          </div>
        </form>
          
        
      </div>
      
    </div>
  </div>
</div>


<div class="modal fade " id="addcitymodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog ">
    <div class="modal-content ">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="fas fa-plus"></i> City</h1>
      </div>
      <div class="modal-body rounded-2 shadow">
        <form action="{% url 'add_city' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          
          <input type="text" name="name" class="form-control mt-2 mb-2" placeholder="City Name"  required>
          
          <div class="row">
              <div class="col-lg-8"></div>
              <div class="col-lg-4">
                <button type="submit" class="btn1 w-100 mt-2 mb-2">Save <i class="fas fa-save ms-1"></i></button>
              </div>
          </div>
        </form>
          
        
      </div>
      
    </div>
  </div>
</div>

<div class="modal fade " id="addlocationmodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog ">
    <div class="modal-content ">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="fas fa-plus"></i> Location</h1>
      </div>
      <div class="modal-body rounded-2 shadow">
        <form action="{% url 'add_location' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <select id="country-select" name="country" class="form-select  mt-2 mb-2" required>
            <option value="" hidden>Select Country</option>
            {% for i in country %}
            <option class="select-hover" value="{{i.id}}">{{i.name}}</option>
            {% endfor %}
          </select>
          <select name="state" class="form-select  mt-2 mb-2" required>
            <option  value="" hidden>Select State</option>
            {% for i in state %}
            <option class="select-hover" value="{{i.id}}">{{i.name}}</option>
            {% endfor %}
          </select>
          <select name="city" class="form-select  mt-2 mb-2" required>
            <option value="" hidden>Select City</option>
            {% for i in city %}
            <option class="select-hover" value="{{i.id}}">{{i.name}}</option>
            {% endfor %}
          </select>
          <input type="text" name="name" class="form-control mt-2 mb-2" placeholder="Location Name"  required>
          <input type="text" name="pincode" class="form-control mt-2 mb-2" placeholder="Pincode"  required>

          <div class="row">
              <div class="col-lg-8"></div>
              <div class="col-lg-4">
                <button type="submit" class="btn1 w-100 mt-2 mb-2">Save <i class="fas fa-save ms-1"></i></button>
              </div>
          </div>
        </form>
          
        
      </div>
      
    </div>
  </div>
</div>








<!--edit Modal -->
{% for i in all_location %}
<div class="modal fade " id="editlocationmodal{{i.id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog ">
    <div class="modal-content ">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="fas fa-edit"></i> Location</h1>
      </div>
      <div class="modal-body rounded-2 shadow">
        <form action="{% url 'edit_location' i.id %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <label for="">Country</label>
          <select name="country" class="form-select  mt-2 mb-2" required>
            <option value="{{i.country.id}}" hidden>{{i.country.name}}</option>
            {% for i in country %}
            <option class="select-hover" value="{{i.id}}">{{i.name}}</option>
            {% endfor %}
          </select>
          <label for="">State</label>
          <select name="state" class="form-select  mt-2 mb-2" required>
            <option  value="{{i.state.id}}" hidden>{{i.state.name}}</option>
            {% for i in state %}
            <option class="select-hover" value="{{i.id}}">{{i.name}}</option>
            {% endfor %}
          </select>
          <label for="">City</label>
          <select name="city" class="form-select  mt-2 mb-2" required>
            <option value="{{i.city.id}}" hidden>{{i.city.name}}</option>
            {% for i in city %}
            <option class="select-hover" value="{{i.id}}">{{i.name}}</option>
            {% endfor %}
          </select>
          <label for="">Location</label>
          <input type="text" name="name" class="form-control mt-2 mb-2" value="{{i.name}}"  required>
          <label for="">Pincode</label>
          <input type="text" name="pincode" class="form-control mt-2 mb-2" value="{{i.postal_code}}"  required>
          
          <div class="row">
              <div class="col-lg-8"></div>
              <div class="col-lg-4">
                <button type="submit" class="btn1 w-100 mt-2 mb-2">Update <i class="fas fa-save ms-1"></i></button>
              </div>
          </div>
        </form>
          
        
      </div>
      
    </div>
  </div>
</div>
{% endfor %}



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {

    $('#location-card').click(function() {
      $('#country-table').addClass('hidden');
      $('#state-table').addClass('hidden');
      $('#city-table').addClass('hidden');
      $('#location-table').removeClass('hidden');
    });

    $('#country-card').click(function() {
      $('#country-table').removeClass('hidden');
      $('#state-table').addClass('hidden');
      $('#city-table').addClass('hidden');
      $('#location-table').addClass('hidden');
    });
  
    $('#state-card').click(function() {
      $('#country-table').addClass('hidden');
      $('#state-table').removeClass('hidden');
      $('#city-table').addClass('hidden');
      $('#location-table').addClass('hidden');
    });

    $('#city-card').click(function() {
      $('#country-table').addClass('hidden');
      $('#state-table').addClass('hidden');
      $('#city-table').removeClass('hidden');
      $('#location-table').addClass('hidden');
    });

   

    // Add similar click functions for other cards if needed
  });
</script>


<!-- <script>
  function deleteCountry(pk) {
    $.ajax({
        type: 'POST',
        url: '/delete-country/' + pk + '/',
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert(response.message);
                $('#country-row-' + pk).remove(); // Remove the row from the table
            } else {
                alert(response.message);
            }
        },
        error: function(xhr, status, error) {
            alert('An error occurred: ' + error);
        }
    });
  }
</script> -->


<script>

  $(document).ready(function() {
      // Check if the page was reloaded after deleting a country
      var urlParams = new URLSearchParams(window.location.search);
      var action = urlParams.get('action');

      if (action === 'deleteCountry') {
          // Store visibility state in session storage
          sessionStorage.setItem('countryTableVisible', 'true');

          // Remove the query parameter from the URL after processing
          var newUrl = removeURLParameter(location.href, 'action');
          history.pushState(null, '', newUrl);
      } else {
          // Clear session storage for default case
          // sessionStorage.removeItem('countryTableVisible');
      }

      // Check if the country table should be visible
      var countryTableVisible = sessionStorage.getItem('countryTableVisible');
      if (countryTableVisible === 'true') {
          // Manipulate table visibility
          $('#country-table').removeClass('hidden');
          $('#state-table').addClass('hidden');
          $('#city-table').addClass('hidden');
          $('#location-table').addClass('hidden');
      } else {
          // Default visibility state
          $('#country-table').addClass('hidden');
          $('#state-table').addClass('hidden');
          $('#city-table').addClass('hidden');
          $('#location-table').removeClass('hidden');
      }
  });

  function deleteCountry(pk) {
      $.ajax({
          type: 'POST',
          url: '/delete-country/' + pk + '/',
          data: {
              csrfmiddlewaretoken: '{{ csrf_token }}' // Replace with your actual CSRF token
          },
          success: function(response) {
              if (response.success) {
                  var successMessage = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                      '<strong>Success <i class="fas fa-check-circle icon"></i></strong><span class="ms-2">' +
                      response.message + '</span>' +
                      '<button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>';
                  $('#message-section').html(successMessage);

                  // Store visibility state in session storage
                  sessionStorage.setItem('countryTableVisible', 'true');

                  // Remove the query parameter from the URL after processing
                  var newUrl = removeURLParameter(location.href, 'action');
                  history.pushState(null, '', newUrl);

                  // Reload the page
                  location.reload();

                  
              } else {
                  var errorMessage = '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                      '<strong>Error <i class="fas fa-exclamation-circle icon"></i></strong><span class="ms-2">' +
                      response.message + '</span>' +
                      '<button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>';
                  $('#message-section').html(errorMessage);
              }
          },
          error: function(xhr, status, error) {
              alert('An error occurred: ' + error);
          }
      });
  }

  // Function to remove a query parameter from the URL
  function removeURLParameter(url, parameter) {
      var urlParts = url.split('?');
      if (urlParts.length >= 2) {
          var prefix = encodeURIComponent(parameter) + '=';
          var queryParams = urlParts[1].split(/[&;]/g);

          // Iterate over the query parameters to remove the specified one
          for (var i = queryParams.length; i-- > 0;) {
              if (queryParams[i].lastIndexOf(prefix, 0) !== -1) {
                  queryParams.splice(i, 1);
              }
          }

          // Reconstruct the URL without the removed query parameter
          url = urlParts[0] + (queryParams.length > 0 ? '?' + queryParams.join('&') : '');
      }
      return url;
  }


</script>



{% endblock %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function() {

    $('#location-card').click(function() {
      $('#country-table').addClass('hidden');
      $('#state-table').addClass('hidden');
      $('#city-table').addClass('hidden');
      $('#location-table').removeClass('hidden');
    });

    $('#country-card').click(function() {
      $('#country-table').removeClass('hidden');
      $('#state-table').addClass('hidden');
      $('#city-table').addClass('hidden');
      $('#location-table').addClass('hidden');
    });
  
    $('#state-card').click(function() {
      $('#country-table').addClass('hidden');
      $('#state-table').removeClass('hidden');
      $('#city-table').addClass('hidden');
      $('#location-table').addClass('hidden');
    });

    $('#city-card').click(function() {
      $('#country-table').addClass('hidden');
      $('#state-table').addClass('hidden');
      $('#city-table').removeClass('hidden');
      $('#location-table').addClass('hidden');
    });

   

    // Add similar click functions for other cards if needed
  });
</script>


<!-- <script>
  function deleteCountry(pk) {
    $.ajax({
        type: 'POST',
        url: '/delete-country/' + pk + '/',
        data: {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert(response.message);
                $('#country-row-' + pk).remove(); // Remove the row from the table
            } else {
                alert(response.message);
            }
        },
        error: function(xhr, status, error) {
            alert('An error occurred: ' + error);
        }
    });
  }
</script> -->


<script>

  $(document).ready(function() {
      // Check if the page was reloaded after deleting a country
      var urlParams = new URLSearchParams(window.location.search);
      var action = urlParams.get('action');

      if (action === 'deleteCountry') {
          // Store visibility state in session storage
          sessionStorage.setItem('countryTableVisible', 'true');

          // Remove the query parameter from the URL after processing
          var newUrl = removeURLParameter(location.href, 'action');
          history.pushState(null, '', newUrl);
      } else {
          // Clear session storage for default case
          // sessionStorage.removeItem('countryTableVisible');
      }

      // Check if the country table should be visible
      var countryTableVisible = sessionStorage.getItem('countryTableVisible');
      if (countryTableVisible === 'true') {
          // Manipulate table visibility
          $('#country-table').removeClass('hidden');
          $('#state-table').addClass('hidden');
          $('#city-table').addClass('hidden');
          $('#location-table').addClass('hidden');
      } else {
          // Default visibility state
          $('#country-table').addClass('hidden');
          $('#state-table').addClass('hidden');
          $('#city-table').addClass('hidden');
          $('#location-table').removeClass('hidden');
      }
  });

  function deleteCountry(pk) {
      $.ajax({
          type: 'POST',
          url: '/delete-country/' + pk + '/',
          data: {
              csrfmiddlewaretoken: '{{ csrf_token }}' // Replace with your actual CSRF token
          },
          success: function(response) {
              if (response.success) {
                  var successMessage = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                      '<strong>Success <i class="fas fa-check-circle icon"></i></strong><span class="ms-2">' +
                      response.message + '</span>' +
                      '<button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>';
                  $('#message-section').html(successMessage);

                  // Store visibility state in session storage
                  sessionStorage.setItem('countryTableVisible', 'true');

                  // Remove the query parameter from the URL after processing
                  var newUrl = removeURLParameter(location.href, 'action');
                  history.pushState(null, '', newUrl);

                  // Reload the page
                  location.reload();

                  
              } else {
                  var errorMessage = '<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                      '<strong>Error <i class="fas fa-exclamation-circle icon"></i></strong><span class="ms-2">' +
                      response.message + '</span>' +
                      '<button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="alert" aria-label="Close"></button>' +
                      '</div>';
                  $('#message-section').html(errorMessage);
              }
          },
          error: function(xhr, status, error) {
              alert('An error occurred: ' + error);
          }
      });
  }

  // Function to remove a query parameter from the URL
  function removeURLParameter(url, parameter) {
      var urlParts = url.split('?');
      if (urlParts.length >= 2) {
          var prefix = encodeURIComponent(parameter) + '=';
          var queryParams = urlParts[1].split(/[&;]/g);

          // Iterate over the query parameters to remove the specified one
          for (var i = queryParams.length; i-- > 0;) {
              if (queryParams[i].lastIndexOf(prefix, 0) !== -1) {
                  queryParams.splice(i, 1);
              }
          }

          // Reconstruct the URL without the removed query parameter
          url = urlParts[0] + (queryParams.length > 0 ? '?' + queryParams.join('&') : '');
      }
      return url;
  }


</script>
